@{ ViewBag.Title = "Home"; }

<div id="define">
    <div class="page-header">
        <h1>define</h1>
    </div>
    <textarea class="js-editor">@ViewBag.Define</textarea>
</div>
<div id="errors">
    <div class="page-header">
        <h1>errors</h1>
    </div>
    <ul>
        @if (ViewBag.Observe.Count == 0)
        {
            <li>No errors!</li>
        }
        else
        {
            foreach (var error in ViewBag.Observe)
            {
                <li>@error.Message</li>
            }
        }
        
    </ul>
</div>


@section PageScripts {
    <script>
        (function(Compilify) {
            var root = this,
                $ = root.jQuery,
                _ = root._,
                CodeMirror = root.CodeMirror;
            
            $(function() {
                var editor = $('#define .js-editor')[0];
                
                var validate = _.debounce(function(sender, key) {

                    $.ajax('/home/validate', {
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ code: sender.getValue() }),
                        success: function (msg) {
                            var $list = $('#errors ul').detach().empty();
                            
                            if (msg.data.length === 0) {
                                $list.append('<li>Build completed successfully.</li>');
                            }
                            else {
                                for (var i in msg.data) {
                                    var error = msg.data[i];
                                    var start = error.Location.StartLinePosition;
                                    var end = error.Location.EndLinePosition;
                                    $list.append('<li>' + error.Message + '</li>');
                                }
                            }
                            
                            $('#errors').append($list);
                        }
                    });
                }, 500);

                // Set up editor
                Compilify.Editor = CodeMirror.fromTextArea(editor, {
                    indentUnit: 4,
                    lineNumbers: true,
                    height: 'dynamic',
                    minHeight: '600px',
                    
                    onKeyEvent: validate
                    
                });
            });
        }).call(window, window.Compilify || {});
    </script>
}
