@using System.Globalization
@{ ViewBag.Title = "Home"; }

<div id="define">
    <div class="page-header">
        <h1>code</h1>
    </div>
    <textarea class="js-editor">@ViewBag.Define</textarea>
</div>
<div id="errors">
    <div class="page-header">
        <h1>errors</h1>
    </div>
    <ul>
        @if (ViewBag.Observe.Count == 0)
        {
            <li>No errors!</li>
        }
        else
        {
            foreach (var error in ViewBag.Observe)
            {
                <li>@error.Info.GetMessage(CultureInfo.InvariantCulture)</li>
            }
        }
        
    </ul>
</div>


@section PageScripts {
    <script>
        "use strict";
        
        (function(Compilify) {
            var root = this,
                $ = root.jQuery,
                _ = root._,
                CodeMirror = root.CodeMirror;
            
            var validate = _.debounce(function(sender, key) {
                $.ajax('/home/validate', {
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ code: sender.getValue() }),
                    success: function (msg) {
                        var $list = $('#errors ul').detach().empty();

                        if (msg.data.length === 0) {
                            $list.append('<li>Build completed successfully.</li>');
                        }
                        else {
                            for (var i in msg.data) {
                                var error = msg.data[i];
                                
                                $list.append('<li>' + error.Message + '</li>');
                            }
                        }
                            
                        $('#errors').append($list);
                    }
                });
            }, 500);

            $(function() {
                var editor = $('#define .js-editor')[0];

                // Set up editor
                Compilify.Editor = CodeMirror.fromTextArea(editor, {
                    indentUnit: 4,
                    lineNumbers: true,
                    theme: 'neat',
                    mode: 'text/x-csharp',
                    onKeyEvent: validate
                    
                });
            });
        }).call(window, window.Compilify || {});
    </script>
}
